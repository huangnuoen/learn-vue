# 思路

1. 知道data什么时候改变
2. 知道哪些dom需要用到data,当触发setter时把所有用到该数据的dom更新

Dep可以看做是书店，Watcher就是书店订阅者，而Observer就是书店的书，订阅者在书店订阅书籍，就可以添加订阅者信息，一旦有新书就会通过书店给订阅者发送消息。

Dep收集watcher,ob监听数据变化，一有变化，dep会通知收集的watcher,watcher再去触发对应的视图更新

## initData

1. 对data.key作完验证后执行`proxy(vm, `_data`, key)`,把_data代理到vm实例上
2. 执行`observe(data, true /* asRootData */)`，把data变成响应式

## Observer 观察者
### observe()
来看下observe()方法的定义
```
export function observe (value: any, asRootData: ?boolean): Observer | void {
  // value必须是对象且不是vnode实例
  if (!isObject(value) || value instanceof VNode) {
    return
  }
  let ob: Observer | void
  // data已经有__ob__属性 且是observer实例则直接取该值
  if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
    ob = value.__ob__
  } else if (
    shouldObserve &&
    !isServerRendering() &&//非服务端渲染
    (Array.isArray(value) || isPlainObject(value)) &&
    Object.isExtensible(value) &&
    !value._isVue// 不是vue
  ) {
    ob = new Observer(value)
  }
  if (asRootData && ob) {
    ob.vmCount++
  }
  return ob
}
```
这里先对data作类型校验和__ob__属性检测，没有__ob__时在对data实例化一个Observer，返回该实例

### new Observer()
1. 对this.value,this.dep,this.vmCount赋值
2. `def(value, '__ob__', this)`对属性作一层封装，不直接赋值，是因为该属性设定为不可枚举
3. 对`value`作类型判断，分别为数组和对象
4. 数组：`this.observeArray(value)`，递归对每个item作`observe`处理..
5. 对象：`this.walk(value)`,对`value`的每个属性作`defineReactive`处理

### defineReactive
1. 每个Key都会实例化一个Dep(收集watcher)
2. 获取属性描述符
3. 没有getter或者有setter并且没有传入初始化值时对val初始化
4. 对子值递归调用observe `childOb = !shallow && observe(val)`
5. **重新定义属性描述符的getter和setter** 这使得当data中有数据变化时可以通过getter/setter监测到

## 收集依赖，订阅watcher
目的：当数据变化时，触发setter时，可以知道要通知哪些watcher去做相应的处理

依赖可以理解成当前数据绑定的视图组(watcher)，一个key有一个deps
```
get: function reactiveGetter () {
  const value = getter ? getter.call(obj) : val
  // 依赖收集过程
  if (Dep.target) {
    dep.depend()
    if (childOb) {
      childOb.dep.depend()
      if (Array.isArray(value)) {
        dependArray(value)
      }
    }
  }
  return value
},
```
1. dep.depend()
```
depend () {
  if (Dep.target) {
    Dep.target.addDep(this)
  }
}
```
2. `Dep.target.addDep(this)`
## Watcher订阅

## 派发更新